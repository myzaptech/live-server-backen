# Configuración Nginx para Live Stream API
# Coloca este archivo en: /etc/nginx/sites-available/live-stream
# Crea symlink: sudo ln -s /etc/nginx/sites-available/live-stream /etc/nginx/sites-enabled/

server {
    listen 80;
    server_name tu-dominio.com;  # Cambia esto por tu dominio o IP

    # Tamaño máximo de upload (para streams grandes)
    client_max_body_size 100M;

    # API REST
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    # Archivos HLS (manifests y segmentos)
    location /live {
        alias /var/www/streams/live;
        
        # Headers CORS para permitir reproducción desde cualquier origen
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        add_header Access-Control-Allow-Headers 'Range, Content-Type';
        add_header Access-Control-Expose-Headers 'Content-Length, Content-Range';
        
        # Cache para manifests (muy corto)
        location ~ \.m3u8$ {
            add_header Cache-Control 'no-cache, no-store, must-revalidate';
            add_header Access-Control-Allow-Origin *;
            types {
                application/vnd.apple.mpegurl m3u8;
            }
        }
        
        # Cache para segmentos (puede ser más largo)
        location ~ \.ts$ {
            add_header Cache-Control 'max-age=10';
            add_header Access-Control-Allow-Origin *;
            types {
                video/mp2t ts;
            }
        }
    }

    # Frontend estático (opcional, si quieres servir el frontend desde aquí)
    location / {
        root /var/www/html/live-stream-frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}

# Configuración RTMP (requiere nginx-rtmp-module)
# Si usas node-media-server, esto NO es necesario
# Solo descomenta si quieres usar Nginx como servidor RTMP

# rtmp {
#     server {
#         listen 1935;
#         chunk_size 4096;
#         
#         application live {
#             live on;
#             record off;
#             
#             # Callback a tu API cuando inicia/detiene un stream
#             on_publish http://localhost:3000/api/stream/start;
#             on_publish_done http://localhost:3000/api/stream/stop;
#         }
#     }
# }
